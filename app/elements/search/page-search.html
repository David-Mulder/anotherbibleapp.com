<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="./bible-search.html">
<link rel="import" href="./topical-search.html">

<link id="bible-reference-parser" rel="import" href="../utils/bible-reference-parser.html">

<dom-module id="page-search">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host{
        background: var(--primary-color-50);
        position: absolute;
        top: 0px;
        left: 0px;
        right: 0px;
        bottom: 0px;
        display: flex;
        flex-direction: column;
      }
      .search-box {
        background-color: #fff;
        border: 1px solid #eee;
        box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.26);
        height: 40px;
        max-width: 800px;
        margin: auto;
        @apply(--layout-flex);
        @apply(--layout-center);
        @apply(--layout-horizontal);
      }

      .search-box iron-icon {
        color: var(--google-grey-700);
        fill: var(--google-grey-700);
        margin: 0 8px;
      }

      .search-box input {
        font-size: 20px;
        outline: 0;
        border: none;
      }

      .content {
        overflow:auto;
        padding: 0px 10px;
        flex:1;
      }
      .search-box input {
        @apply(--layout-flex);
      }
      .instructions{
        max-width: 800px;
        margin: auto;
        margin-top: 30px;
        text-align: center;
        color: var(--secondary-text-on-background-color)
      }
    </style>

    <paper-toolbar class="medium-tall">
      <intelligent-title title="{{_smartCaps(title)}}"></intelligent-title>
      <div class="search-box bottom">
        <iron-icon icon="search"></iron-icon>
        <input id="searchInput" is="iron-input" value="[[searchQuery]]" on-keyup="_setValueIfEnter" x-webkit-speech></input>
        <!--<iron-icon icon="av:mic"></iron-icon>-->
      </div>
    </paper-toolbar>

    <div class="content">
      <div class="instructions" hidden$="{{searchStarted}}">
        Enter your search query above. To search in a specific book use <code>in:Matthew</code><br><br>
        To learn more about search, <a href="/help/search">tap here</a>.
      </div>
      <div hidden$="{{!searchStarted}}">
        <topical-search search-query="{{_searchQuery}}" on-results="_finishedTopicalSearch" on-no-results="triggerBibleSearch"></topical-search>
        <bible-search id="bibleSearch" search-query="{{_searchQuery}}"></bible-search>
      </div>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      var BibleReference = require('bible-reference-parser');

      Polymer({
        is: 'page-search',

        properties: {
          searchQuery: {
            type: String,
            notify: true,
            observer: '_setSearchStarted'
          },
          searchStarted: {
            type: Boolean,
            value: false
          },
          _operatorLessSearchQuery: {
            type: String,
            computed: '_getOperatorLessSearchQuery(searchQuery)'
          }
        },

        behaviors: [
          abaBehaviors.page,
          abaBehaviors.text
        ],

        listeners: {
          'page-finished-animating': '_focusIfEmptySearch'
        },

        _getOperatorLessSearchQuery: function(){
          return this.searchQuery.split(' ').filter(function(word){
            return word.indexOf(':') == -1
          }).join(' ').trim();
        },

        _focusIfEmptySearch: function(){
          this.async(function(){

            if(this._operatorLessSearchQuery.length == 0){
              this.$.searchInput.focus();
            }
          });
        },

        _setSearchStarted: function(){
          var reference = new BibleReference(this.searchQuery);
          //page.len == 0 is true if directly navigated to the page, e.g. through opensearch
          if(reference.valid && page.len == 0){
            page.replace('/book/'+reference.toString());
          }else {
            this._searchQuery = this.searchQuery;
            this.searchStarted = this._operatorLessSearchQuery.length > 0;
            this.title = this.searchStarted ? this.searchQuery : 'Search'
            if (this.searchStarted) {
              app.loading('search');
            }
          }
        },

        _finishedTopicalSearch: function(){
          app.finishedLoading('search');
        },

        _setValueIfEnter: function(ev){
          if(ev.keyCode == 13){
            app.navigateTo('/search/'+encodeURIComponent(ev.target.value));
            ev.target.blur();
            //this.searchQuery = ev.target.value;
          }
        },

        triggerBibleSearch: function(){
          this.$.bibleSearch.search();
        }
      });
    })();
  </script>

</dom-module>
