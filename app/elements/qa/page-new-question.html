<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="bible-markdown-editor.html">

<link id="bible-reference-parser" rel="import" href="../utils/bible-reference-parser.html">

<dom-module id="page-new-question">
  <template>
    <style include="shared-styles"></style>
    <style include="page-styles"></style>
    <style>
      .new-question-page{
        background: var(--primary-color-50);
        flex: 1;
        padding: 20px;
        overflow: auto;
      }
      paper-card{
        max-width: 1300px;
        display: block;
        width: 100%;
        margin: auto;
      }

      .stepper {
        display: flex;
        flex-direction: column;
      }
      .stepper .step{
        display: flex;
        flex-direction: row;
      }
      .stepper .step [data-step]{
        margin: 10px;
        width: 24px;
        position: relative;
        /*
        34 px
        17px + 1px + 17px
        */
        background: linear-gradient(to right, transparent 12px, rgba(189,189,189, .87) 12px, transparent 13px);
      }
      .stepper .step [data-step]::before{
        content: ' ';
        position: absolute;
        background: var(--card-dialog-color);
        left:0px;
        top:0px;
        right:0px;
        height: 34px;
      }
      .stepper .step [data-step]::after{
        position: absolute;
        content: attr(data-step);
        display: block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        background-color: var(--primary-color);
        color: var(--text-on-primary-color);
        border-radius: 12px;
        text-align: center;
      }

      .stepper .step .content{
        flex: 1;
        margin: 10px;
        padding-top: 2px;
        padding-bottom: 10px;
      }

      #title{
        --paper-input-container-input: {
          font-size: 22px;
        };
      }

      paper-input.no-upper-padding{
        --paper-input-container: {
          padding-top: 0px;
        };
      }
      .step paper-radio-button{
        padding: 6px;
      }
    </style>
    <paper-toolbar>
      <intelligent-title title="Ask a Question" allow-back></intelligent-title>
      <span class="flex"></span>
    </paper-toolbar>
    <div class="new-question-page">

      <auth-api logged-in="{{loggedIn}}"></auth-api>
      <auth-api id="api" method="PUT" action="question" param-title="{{title}}" param-category="{{category}}" param-text="{{questionText}}" param-verses="{{versesAsNumbers}}"></auth-api>

      <div hidden="{{!loggedIn}}">
        <paper-card id="card">

          <div class="card-content">

            <div class="stepper">
              <div class="step">
                <div data-step="1"></div>
                <div class="content">
                  <paper-input id="title" label="Your question in one sentence (title)" class="no-upper-padding" value="{{title}}" char-counter maxlength="200" minlength="15"></paper-input>
                  regarding
                  <template is="dom-repeat" items="{{verses}}">
                    {{item}}
                  </template>
                </div>
              </div>
              <div class="step">
                <div data-step="2"></div>
                <div class="content">
                  This question is about:<br>
                  <paper-radio-group selected="{{category}}">
                    <paper-radio-button name="acts">What is happening in the text</paper-radio-button><br>
                    <paper-radio-button name="author">The contextual meaning of the text for the text's original audience</paper-radio-button><br>
                    <paper-radio-button name="application">The modern day applications of the text</paper-radio-button>
                  </paper-radio-group>
                </div>
              </div>
              <div class="step">
                <div data-step="3"></div>
                <div class="content">
                  <paper-checkbox checked="{{agreeReadRules}}">I have read the rules about asking questions and how to format them.</paper-checkbox> If not <a href="/help/how-to-ask" target="_blank">click here</a> to view them.
                </div>
              </div>
              <div class="step">
                <div data-step="4"></div>
                <div class="content">
                  <bible-markdown-editor value="{{questionText}}" label="Your question in detail" rows="7">
                    <p style="font-size: 14px;opacity: .8">
                      Note: Your question will always be shown right next to the verses you selected.
                    </p>
                  </bible-markdown-editor>
                </div>
              </div>
            </div>

          </div>

          <div class="card-actions">
            <paper-button on-tap="submit">Ask your Question</paper-button>
          </div>

        </paper-card>
      </div>
      <!--
      <div hidden="{{!loggedIn}}">
        <div id="title">
          <paper-card>
            <paper-input label="Your question in one sentence (title)"></paper-input>
          </paper-card>
        </div>
        <div class="questionEditor">
          <paper-card>
            <paper-textarea value="{{questionText}}" label="Your question in detail" rows="3" always-float-label></paper-textarea>
          </paper-card>
          <paper-card>
            <marked-element markdown="{{questionText}}">
              <div class="markdown-html"></div>
            </marked-element>
          </paper-card>
        </div>
      </div>
      -->
      <div hidden="{{loggedIn}}">
        You need to log in to do this
      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      var BibleReference = require('bible-reference-parser');

      Polymer({
        is: 'page-new-question',

        properties: {
          versesString: String,
          verses: Array,
          animationConfig: {
            value: function() {
              return {
                // the incoming page defines the 'entry' animation
                'exit': [{
                  name: 'hero-animation',
                  id: 'question-card',
                  fromPage: this
                }, {
                  name: 'fade-out-animation',
                  node: this
                }],
                'entry': [{
                  name: 'slide-from-bottom-animation',
                  node: this
                }, {
                  name: 'fade-in-animation',
                  node: this
                }]
              }
            }
          },
          sharedElements: {
            value: function() {
              return {
                'question-card': this.$.card
              }
            }
          }
        },
        observers: [
          'parseVerses(versesString)'
        ],
        listeners: {
          'page-became-visible': '_checkLoggedInOrRedirect'
        },
        behaviors: [
          abaBehaviors.page
        ],
        ready: function(){

          //this.set('loggedIn', false);
        },
        _checkLoggedInOrRedirect: function(){
          if(!this.loggedIn){
            redirect('/login');
          }
        },
        parseVerses: function(){
          var verses = this.versesString.split(',');
          verses = verses.map(verse => new BibleReference(verse));
          this.set('verses', verses);
          this.set('versesAsNumbers', verses.map(verse => verse.toNumeric()))
        },
        submit: function(){
          var valid = true;
          if(!this.agreeReadRules){
            app.toast('Please read the rules before asking your question');
            valid = false;
          }
          if(this.title.length < 15){
            app.toast('Please make your title more descriptive');
            valid = false;
          }
          if(!this.questionText || this.questionText.length < 30){
            app.toast('Please describe your question in more terms');
            valid = false;
          }
          if(!this.category){
            app.toast('Please pick one of the categories');
            valid = false;
          }
          if(valid){
            this.$.api.execute().then(function(id){
              page.replace('/question/'+id)
            }).catch(function(errs){
              alert('Some validation error occurred');
              console.info('validation', errs);
            });
          }
        }
      });
    })();
  </script>

</dom-module>
