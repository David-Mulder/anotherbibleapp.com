<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../text/bible-snippet.html">
<link rel="import" href="qa-post.html">
<link rel="import" href="bible-markdown-editor.html">

<dom-module id="page-question">
  <template>
    <style include="shared-styles"></style>
    <style include="page-styles"></style>
    <style>
      qa-post{
        max-width: 800px;
        margin: auto;
      }
      .page-content paper-card{
        max-width: 800px;
      }
      paper-drawer-panel [main]{
        display: flex;
        flex-direction: column;
      }
      paper-drawer-panel [drawer]{
        display: flex;
        flex-direction: column;
      }
      paper-drawer-panel [drawer] > div{
        padding: 10px;
        background: var(--primary-color-50);
        flex: 1;
      }
      hr.divider{
        display: block;
        width: 100%;
        max-width: 850px;
        margin: 20px auto;
        border: 0px;
        border-top: 1px dotted rgba(0,0,0,.2);
      }
      #noAnswers{
        text-align: center;
      }
      #noAnswers span{
        color: var(--secondary-text-on-primary-color-50);
      }
      #newAnswer{
        margin-top: 20px;
      }
      #drawerContent{
        overflow: auto;
      }
      qa-post[type='answer']{
        margin-bottom: 20px;
      }
    </style>
    <auth-api id="api" action="qa/:id" param-id="{{id}}" response="{{qas}}"></auth-api>
    <paper-drawer-panel right-drawer>
      <div main>
        <paper-toolbar>
          <intelligent-title title="Another Bible App" no-title-if-wide></intelligent-title>
        </paper-toolbar>
        <div class="page-content">

          <qa-post type="question" post="{{qas.question}}"></qa-post>

          <hr class="divider">

          <template is="dom-repeat" items="{{qas.answers}}" as="answer">
            <qa-post type="answer" post="{{answer}}"></qa-post>
          </template>

          <div id="noAnswers" hidden$="{{anyAnswers}}">
            <span>Nobody has answered this question yet. Know somebody who can? Share this link with them!</span>
            <hr class="divider">
          </div>

          <auth-api id="newAnswerApi" method="put" action="answer" param-question="{{id}}" param-text="{{answerText}}"></auth-api>

          <paper-card heading="Your Answer" id="newAnswer">
            <div class="card-content">
              <bible-markdown-editor value="{{answerText}}"></bible-markdown-editor>
            </div>
            <div class="card-actions">
              <paper-button on-tap="submitAnswer">Submit your Answer</paper-button>
            </div>
          </paper-card>

        </div>
      </div>
      <div drawer>
        <paper-toolbar>
          <span>Related</span>
        </paper-toolbar>
        <div id="drawerContent">
          <paper-card heading="Discussed texts">
            <template is="dom-repeat" items="{{qas.question.verses}}">
              <div class="card-actions">
                <bible-snippet start="{{item}}" end="{{item}}"></bible-snippet>
              </div>
            </template>
          </paper-card>
        </div>
      </div>
    </paper-drawer-panel>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'page-question',

        properties: {

        },
        listeners: {
          'page-became-visible': 'retrieveFromApi'
        },
        observers: [
          'setTitle(qas.question.title)',
          'setAnyAnswers(qas.answers.splices)'
        ],
        ready: function(){
        },
        retrieveFromApi: function(){
          this.$.api.execute();
        },
        submitAnswer: function(){
          this.$.newAnswerApi.execute().then(() => {
            this.retrieveFromApi();
          });
        },
        setTitle: function(title){
          page.replace('/question/'+this.id+'/'+title.toLowerCase().replace(/ /g, '-').replace(/[^a-zA-Z0-9\-]/g, ''));
          app.setTitle(title);
        },
        setAnyAnswers: function(){
          this.set('anyAnswers', this.qas.answers.length > 0);
        }
      });
    })();
  </script>

</dom-module>
