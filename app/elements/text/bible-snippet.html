<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../utils/utils-books.html">

<script src="../search/lib/lancaster.js"></script>
<script src="../search/lib/smartStemmer.js"></script>

<dom-module id="bible-snippet">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        min-height: 30px;
      }
      #snippet {
        text-align: justify;
      }
      .source{
        margin-top:10px;
        text-align: right;
        color: var(--secondary-text-on-card-dialog-color);
      }
    </style>
    <utils-books id="utils"></utils-books>
    <div id="snippet"></div>
    <div class="source"><small>from</small> <span>{{startReference.book.title}}</span> <span>{{startReference.chapter}}</span></div>
  </template>

  <script>
    (function() {
      'use strict';

      var parser = new DOMParser();

      Polymer({
        is: 'bible-snippet',

        properties: {
          start: {
            type: String
          },
          end: {
            type: String
          },
          highlight: {
            type: String,
            value: ''
          }
        },
        observers: [
          'getText(start, end)'
        ],
        getText: function(start, end) {
          //var text = this.getBoundingClientRect();
          //return false;

          this.endReference = this.$.utils.parseReference(end);
          this.startReference = this.$.utils.parseReference(start);
          var xmlFile = this.resolveUrl('text/'+this.startReference.book.name+'.xml');
          fetch(xmlFile).then(function(response){
            return response.text();
          }).then(function(text){
            var startIndex = text.indexOf('<vn id="'+this.startReference.toString()+'">');
            if(startIndex === -1){
              console.warn('not found start point', this.startReference.toString())
              return;
            }
            var endIndex = text.indexOf('<vn id="'+this.endReference.toString()+'">');
            if(endIndex > -1){
              endIndex = endIndex + 10;
              while(endIndex < text.length){
                endIndex = text.indexOf('<vn id="', endIndex);
                var endIndexQuote = text.indexOf('"', endIndex + '<vn id="'.length);
                var verse = text.substring(endIndex + '<vn id="'.length, endIndexQuote);
                if(verse !== this.endReference.toString()){
                  break;
                }else{
                  endIndex += 1;
                }
                //console.log(verse);
                //return;
              }
              //endIndex = text.indexOf('<vn', endIndex + 4);
            }
            if(endIndex === -1){
              endIndex = text.length;
            }
            this.debug = {
              startIndex: startIndex,
              endIndex: endIndex
            };
            var snippet = text.substring(startIndex, endIndex);
            snippet = snippet.replace(/<\/p>.*?<p>/g,'');
            snippet = snippet.replace(/<n.*?>.*?<\/n>/g, '');
            //snippet = snippet.replace(/<verse-number.*?>.*?<\/verse-number>/g, '');
            snippet = snippet.replace(/<caption>.*?<\/caption>/g,'');
            snippet = snippet.replace(/<.*?>/g,'');

            var highlights = this.highlight.split(/\s/g).map(function(word){
              return smartStemmer(word.toLowerCase().replace(/[^a-z0-9.]+/, ''));
            });
            snippet = snippet.split(/\s/g).map(function(word){
              var stemmed = smartStemmer(word.toLowerCase().replace(/[^a-z0-9]+/, ''));
              if(highlights.indexOf(stemmed) > -1){
                return '<strong>'+word+'</strong>';
              }else{
                return word;
              }
            }).join(' ');

            this.$.snippet.innerHTML = snippet;
            //this.$.snippet.textContent = snippet;
            //console.log(startIndex, endIndex, snippet);

            //console.log('verse-number[id="'+start.book.name+' '+start.chapter+':'+start.verseStart+'"]');
            //console.log(verseStart);
          }.bind(this));
        }
      });
    })();
  </script>

</dom-module>
