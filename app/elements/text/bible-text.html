<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="./chapter-html.html">

<dom-module id="bible-text">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        position: absolute;
        left: 0px;
        bottom: 0px;
        right: 0px;
        top: 0px;
        display: flex;
      }
      iron-list{
        flex: 1;

        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }
    </style>
    <style>
      :host{
      }
      paper-card{
      }
      p{
        text-align: justify;
      }
      ul{
        list-style: none;
        padding-left: 20px;
      }
      ul li{
        font-style: italic;
      }
      vn.selected{
        background: var(--accent-color-200);
        color: var(--text-on-accent-color-200);
      }
    </style>
    <style>
      :host([mode='read']){
        background: white;
      }
      :host([mode='read']) chapter{
        display: block;
      }
      :host([mode='read']) n, :host([mode='read']) pericope{
        display: none;
      }
    </style>
    <style>
      :host([mode='study']) chapter{
        background: var(--card-dialog-color);
        margin: 10px 10px 0px 10px;
        padding: 20px;
        display: block;
        box-shadow: rgba(0, 0, 0, 0.098) 0px 2px 4px, rgba(0, 0, 0, 0.098) 0px 0px 3px;
      }
      :host([mode='study']) chapter::before{
        content: attr(n);
        display: inline-block;
        float: left;
        font-size: 48px;
        padding-right: 10px;
        padding-bottom: 10px;
      }
      :host([mode='study']) pericope{
        display: inline-block;
        text-indent:0px;
        padding-left:10px;
        padding-right:10px;
        margin-top: 10px;
        margin-bottom: 5px;
        font-size: .9em;
        font-weight: 400;
        text-align: left;
        text-decoration: underline;
      }
      :host([mode='study']) n io{
        display: none;
      }
      :host([mode='study']) n{
        position: relative;
      }
      :host([mode='study']) n:hover io{
        display: block;
        position: absolute;
        left: 0px;
        top: 29px;
        background: var(--inverse-card-dialog-color);
        color: var(--text-on-inverse-card-dialog-color);
        width: 150px;
        margin-left: -75px;
        padding: 5px;
        font-size: 10px;
        font-family: Roboto;
        font-weight: normal;
        opacity: .9;
        border-radius: 2px;
      }
      :host([mode='study']) n:after{
        content: 'NOTE';
        position: relative; top: -1em;
        font-size: 7px;
        color: rgba(0, 0, 0, 0.6);
        font-family: Verdana;
      }
      :host([mode='study']) vn[first]::before{
        content: attr(n);
        display: inline-block;
        text-align: center;
        font-size: 9px;
        border: 1px solid rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        min-width: 12px;
        min-height: 12px;
        transform: scale(0.9) translateY(-20%);
      }
      :host([mode='study']) sd{
        font-variant: small-caps;
      }
      :host([mode='study']) im{
        font-style: italic;
      }
    </style>
    <iron-list id="text" items="{{chapters}}" as="book" on-tap="selectVerse">
      <template>
        <chapter-html html="{{book}}" selected-verses="{{selectedVerses}}"></chapter-html>
      </template>
    </iron-list>
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({

        is: 'bible-text',

        properties: {
          textRef: {
            type: Object,
            observer: 'loadBook'
          },
          chapters: {
            type: Array,
            value: []
          },
          mode: {
            type: String,
            reflectToAttribute: true
          },
          selectedVerses: {
            type: Array,
            notify: true
          },
          selectionMode: {
            type: String,
            value: 'single'
          }
        },

        observers: [
          'resetSizes(mode)'
        ],

        ready: function() {
          //this.scopeSubtree(this.$.text, true);
          this.selectedVerses = [];
        },

        loadBook: function(){
          var url = this.resolveUrl('text/'+this.textRef.book.name+'.xml');

          var httpRequest = new XMLHttpRequest();
          httpRequest.onreadystatechange = function(){
            this.set('chapters', []);
            if(httpRequest.readyState === XMLHttpRequest.DONE) {
              if(httpRequest.status === 200) {
                var chapters = httpRequest.responseXML.querySelectorAll('chapter');
                for(var i=0; i<chapters.length;i++){
                  this.push('chapters', chapters[i].outerHTML);
                }
                this.async(function(){
                  this.scrollToReference();
                });
                //this.$.text.innerHTML = httpRequest.responseText;
              }
            }
          }.bind(this);
          httpRequest.responseType = 'document';
          httpRequest.open('GET', url);
          httpRequest.send();
        },

        resetSizes: function(){
          this.$.text.items.forEach(function(item, i){
            this.$.text.updateSizeForItem(item);
          }.bind(this));
          var i = this.$.text._firstVisibleIndexVal;
          this.async(function(){
            this.$.text.scrollToIndex(i);
          }, 0);
        },

        scrollToReference: function() {
          if(this.textRef.chapter){
            this.$.text.scrollToIndex(this.textRef.chapter);
            if(this.textRef.verseStart){
              this.set('selectedVerses', [this.textRef.toString()])
            }
          }
        },

        selectVerse: function(ev){
          var verseNumberElement = ev.path.find((el) => el.nodeName && el.nodeName.toLowerCase() === 'vn');
          if(this.selectionMode === 'multiple'){
            if(verseNumberElement) {
              var isSelected = this.selectedVerses.includes(verseNumberElement.id);
              if (isSelected) {
                //unselect
                this.splice('selectedVerses', this.selectedVerses.indexOf(verseNumberElement.id), 1);
              } else {
                //select
                this.push('selectedVerses', verseNumberElement.id);
              }
            }
          }else{
            if(!verseNumberElement || (this.selectedVerses.length > 0 && this.selectedVerses[0] == verseNumberElement.id)){
              this.set('selectedVerses', []);
            }else{
              this.set('selectedVerses', verseNumberElement ? [verseNumberElement.id] : []);
            }
          }
          this.fire('verse-selected', verseNumberElement ? verseNumberElement.id : undefined)
        }

      });
    })();
  </script>

</dom-module>
