<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="block-html.html">

<dom-module id="bible-text">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        position: absolute;
        left: 0px;
        bottom: 0px;
        right: 0px;
        top: 0px;
        display: flex;
      }
      iron-list{
        flex: 1;

        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }
    </style>
    <style>
      :host{
      }
      paper-card{
      }
      pa{
        display: block;
        text-align: justify;
        padding-bottom: 15px;;
      }
      ul{
        list-style: none;
        padding-left: 20px;
        margin: 0px;
        padding-top: 20px;
      }
      ul li{
        font-style: italic;
      }
      vn.selected, vn.selected li{
        background: var(--accent-color-200);
        color: var(--text-on-accent-color-200);
      }
      .license{
        margin-bottom: 20px;
      }
      .license p{
        margin-top:0px;
        font-size: small;
      }
    </style>
    <style>
      :host([mode='read']){
        background: white;
      }
      :host([mode='read']) chapter{
        display: block;
      }
      :host([mode='read']) n, :host([mode='read']) pericope{
        display: none;
      }
    </style>
    <style>
      :host([mode='study']) block-html[chapter-start] > div{
        margin-top: 10px;
        padding-top: 20px;
      }
      :host([mode='study']) block-html > div{
        background: var(--card-dialog-color);
        margin: 0px 10px 0px 10px;
        padding-left: 20px;
        padding-right: 20px;
        padding-bottom: 1px;
        padding-top: 0px;
        display: block;
        /*box-shadow: rgba(0, 0, 0, 0.098) 0px 2px 4px, rgba(0, 0, 0, 0.098) 0px 0px 3px;*/
      }
      :host([mode='study']) block-html[chapter-start] > div::before{
        content: attr(chapter-number);
        display: inline-block;
        float: left;
        font-size: 32px;
        min-width: 40px;
        text-align: center;
      }
      :host([mode='study']) block-html[chapter-start] > div::after{
        content: '';
        display: block;
        clear: both;
      }
      :host([mode='study']) pericope{
        display: block;
        text-indent:0px;
        font-size: .9em;
        font-weight: 400;
        text-align: left;
        text-decoration: underline;
        padding-bottom: 15px;;
      }

      :host([mode='study']) n io{
        display: none;
      }
      :host([mode='study']) n{
        position: relative;
      }
      /*
      :host([mode='study']) n:hover io{
        display: block;
        position: absolute;
        left: 0px;
        top: 29px;
        background: var(--inverse-card-dialog-color);
        color: var(--text-on-inverse-card-dialog-color);
        width: 150px;
        margin-left: -75px;
        padding: 5px;
        font-size: 10px;
        font-family: Roboto;
        font-weight: normal;
        opacity: .9;
        border-radius: 2px;
      }
      */
      :host([mode='study']) n:after{
        content: 'NOTE';
        position: relative; top: -1em;
        font-size: 7px;
        color: rgba(0, 0, 0, 0.6);
        font-family: Verdana;
        cursor: pointer;
      }
      :host([mode='study']) vn[first]::before{
        content: attr(n);
        display: inline-block;
        text-align: center;
        font-size: 9px;
        border: 1px solid rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        min-width: 12px;
        min-height: 12px;
        transform: scale(0.9) translateY(-20%);
      }
      :host([mode='study']) sd{
        font-variant: small-caps;
      }
      :host([mode='study']) im{
        font-style: italic;
      }
    </style>
    <utils-books id="utils"></utils-books>
    <iron-list id="text" items="{{blocks}}" as="block" on-tap="selectVerse" on-scroll="savePosition">
      <template>
        <block-html html="{{block.html}}" chapter-start$="{{block.start}}" chapter-end$="{{block.end}}" selected-verses="{{selectedVerses}}" chapter-number="{{block.chapterNumber}}" class$="{{block.class}}"></block-html>
      </template>
    </iron-list>
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({

        is: 'bible-text',

        properties: {
          textRef: {
            type: Object,
            observer: 'loadBook'
          },
          chapters: {
            type: Array,
            value: []
          },
          blocks: {
            type: Array
          },
          mode: {
            type: String,
            reflectToAttribute: true
          },
          selectedVerses: {
            type: Array,
            notify: true
          },
          selectionMode: {
            type: String,
            value: 'single'
          },
          highlightVerse: {
            type: Boolean,
            value: true
          }
        },

        observers: [
          'resetSizes(mode)'
        ],

        ready: function() {
          //this.scopeSubtree(this.$.text, true);
          this.selectedVerses = [];
          this.blocks = [];
        },

        loadBook: function(){
          console.info('loading book', this.textRef);

          this.highlightVerse = true;

          var url = this.resolveUrl('text/'+this.textRef.book.name+'.xml');

          var httpRequest = new XMLHttpRequest();
          httpRequest.onreadystatechange = function(){
            this.set('chapters', []);
            if(httpRequest.readyState === XMLHttpRequest.DONE) {
              if(httpRequest.status === 200) {

                console.info('loaded book', this.textRef.book)

                this.loadBlocksFromBook(httpRequest.responseXML);

                this.async(function(){
                  this.scrollToReference();
                }, 500);

              }
            }
          }.bind(this);

          httpRequest.responseType = 'document';
          httpRequest.open('GET', url);
          httpRequest.send();
        },

        loadBlocksFromBook: function(book){
          this.blocks = [];
          var chapters = [].slice.call(book.querySelectorAll('chapter'));

          chapters.forEach((chapter, chapterI) => {
            var chapterBlocks = [].slice.call(chapter.querySelectorAll('pa, pericope'));
            chapterBlocks.forEach((block, i) => {
              var firstVerse = block.querySelector('vn');
              if(firstVerse){
                var reference = this.$.utils.parseReference(firstVerse.id);
              }
              this.push('blocks', {
                start: i == 0,
                end: i == chapterBlocks.length - 1,
                debug: i+'/'+(chapterBlocks.length -1),
                html: block.outerHTML,
                chapterNumber: chapterI + 1,
                verseStart: firstVerse ? reference.toNumeric() : null
              });
            });
          });

          this.push('blocks', {
            start: true,
            end: true,
            html: '<p>Scripture quotations marked (LEB) are from the Lexham English Bible. Copyright 2012 Logos Bible Software. Lexham is a registered trademark of Logos Bible Software.</p>',
            class: 'license'
          });

          console.info('loaded', this.blocks, 'blocks');
        },

        resetSizes: function(){
          this.$.text.items.forEach(function(item, i){
            this.$.text.updateSizeForItem(item);
          }.bind(this));
          var i = this.$.text._firstVisibleIndexVal;
          this.async(function(){
            this.$.text.scrollToIndex(i);
          }, 0);
        },

        scrollToReference: function() {

          if(this.textRef.chapter) {
            console.log('searching for', this.textRef.toNumeric());
            var lastValidIndex;
            for (var i = 0; i < this.blocks.length; i++) {
              if (this.blocks[i].verseStart) {
                if (this.blocks[i].verseStart > this.textRef.toNumeric()) {
                  break;
                }
                lastValidIndex = i;
              }
            }
            if (lastValidIndex) {
              if(isNaN(this.textRef.verseStart)){
                lastValidIndex--;
              }
              this.$.text.scrollToIndex(lastValidIndex);
            }
          }

          if(this.highlightVerse){
            if(this.textRef.verseStart){
              this.set('selectedVerses', [this.textRef.toString()])
            }
          }
          //this.blocks.findIndex(block => block.firstVerse);
          /*
          if(this.textRef.chapter){
            this.$.text.scrollToIndex(this.textRef.chapter-1);
            if(this.textRef.verseStart){
              this.set('selectedVerses', [this.textRef.toString()])
            }
          }*/
        },

        selectVerse: function(ev){
          if(ev.path[0].nodeName.toLowerCase() == 'n'){
            app.msg(ev.path[0].textContent);
          }else{
            var verseNumberElement = ev.path.find((el) => el.nodeName && el.nodeName.toLowerCase() === 'vn');
            if(this.selectionMode === 'multiple'){
              if(verseNumberElement) {
                var isSelected = this.selectedVerses.includes(verseNumberElement.id);
                if (isSelected) {
                  //unselect
                  this.splice('selectedVerses', this.selectedVerses.indexOf(verseNumberElement.id), 1);
                } else {
                  //select
                  this.push('selectedVerses', verseNumberElement.id);
                }
              }
            }else{
              if(!verseNumberElement || (this.selectedVerses.length > 0 && this.selectedVerses[0] == verseNumberElement.id)){
                this.set('selectedVerses', []);
              }else{
                this.set('selectedVerses', verseNumberElement ? [verseNumberElement.id] : []);
              }
            }
            this.fire('verse-selected', verseNumberElement ? verseNumberElement.id : undefined)
          }
        },

        savePosition: function(){
          this.debounce('saveScrollPosition', function(){
            var firstIndex = this.$.text.firstVisibleIndex;
            if(this.blocks[firstIndex].verseStart === null){
              firstIndex++;
            }
            this.fire('scroll', {
              verse: this.blocks[firstIndex].verseStart
            });
          }, 100);
        }

      });
    })();
  </script>

</dom-module>
