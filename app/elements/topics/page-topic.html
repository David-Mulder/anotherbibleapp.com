<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="./topic-card.html">

<dom-module id="page-topic">
  <template>
    <style include="shared-styles"></style>
    <style include="page-styles"></style>
    <style>

    </style>
    <paper-toolbar>
      <intelligent-title title="{{beautifulTitle}}" allow-back></intelligent-title>
      <span class="flex"></span>
    </paper-toolbar>
    <div class="page-content">
      <topic-card id="card" topic="{{topic}}" class="card"></topic-card>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'page-topic',

        properties: {
          topicName: {
            type: String
          },
          animationConfig: {
            value: function(){
              return {
                'entry': [{
                  name: 'hero-animation',
                  id: 'topic-card',
                  toPage: this
                }, {
                  name: 'fade-in-animation',
                  node: this
                }],
                'exit': [{
                  name: 'slide-down-animation',
                  node: this
                }, {
                  name: 'fade-out-animation',
                  node: this
                }]
              }
            }
          },
          sharedElements: {
            value: function() {
              return {
                'topic-card': this.$.card
              }
            }
          }
        },
        observers: [
          'topicChanged(topicName)'
        ],
        behaviors: [
          abaBehaviors.text,
          abaBehaviors.page
        ],
        ready: function(){

        },
        topicChanged: function(topicName){
          this.beautifulTitle = this._smartCaps(topicName);

          fetch(this.resolveUrl('./data/topical.js')).then(function(response){
            return response.text();
          }).then(function(text){
            text = text.replace('var topics = ', '');
            text = text.replace(';', '');
            var topicTexts = JSON.parse(text)[topicName];
            var verses = topicTexts.map(function(text){
              var parts = text.split(' ');
              return {
                start: parts[0],
                end: parts[1].length > 0 ? parts[1] : parts[0],
                votes: parts[2]
              };
            });
            this.set('topic', {
              title: this.beautifulTitle,
              verses: verses
            });
          }.bind(this));
        }
      });
    })();
  </script>

</dom-module>
