<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="utils-books/books.js"></script>
<script src="utils-books/bibleReferenceParser.js"></script>

<dom-module id="utils-books">
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'utils-books',

        properties: {
          books: {
            type: Array,
            value: bibleBooks,
            notify: true
          },
          groupedBooks: {
            type: Array,
            notify: true
          },
          sortCategory: {
            type: String,
            observer: 'groupBooksBy'
          }
        },
        groupBooksBy: function(category){
          var books = JSON.parse(JSON.stringify(this.books));
          if(category === 'date'){
            books.sort(function (a, b) {
              return a.timeline.start - b.timeline.start;
            });
          }else if(category === 'name'){
            books.sort(function(a, b) {
              a = a.name.toLowerCase().replace(/[^a-z]/g, '');
              b = b.name.toLowerCase().replace(/[^a-z]/g, '');
              return a > b ? 1 : (a === b ? 0 : -1);
            });
          }else if(category === 'tradition'){
            books.sort(function(a, b) {
              if (a.collection.testament === b.collection.testament) {
                return a.traditionalPosition - b.traditionalPosition;
              } else if (a.collection.testament === 'New') {
                return -1;
              } else {
                return 1;
              }
            });
          }

          this.set('groupedBooks', []);

          var currentListName = '';
          books.forEach(function(book){
            var label;
            if (category === 'date') {
              label = Math.abs(Math.floor(book.timeline.start / 100) * 100);
              label += book.timeline.start < 0 ? ' BC' : 'AD';
            } else if (category === 'name') {
              label = book.name.toUpperCase().replace(/[^A-Z]/g,'')[0];
            } else if (category === 'tradition') {
              //var label = book.collection.testament == "New" ? "New Testament" : "Old Testament";
              label = (book.collection.testament === 'New' ? 'New Testament' : 'Old Testament') + ' - ' + book.collection.subset;
            }
            if(label !== currentListName) {
              this.push('groupedBooks', {
                label: label,
                books: []
              });
              currentListName = label;
            }
            var index = this.groupedBooks.length-1;
            this.push('groupedBooks.'+index+'.books', book);
          }.bind(this));
        },

        parseReference: function(vs){
          if(vs instanceof BibleReference) return vs;
          return new BibleReference(vs);
        }

      });
    })();
  </script>

</dom-module>
