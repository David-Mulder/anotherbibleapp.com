<script src="/bower_components/page/page.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {

    app.set('params', {});

    page(function(ctx, next){
      app.forceNarrow = false;
      app.closeDrawer();
      next();
    });

    page(function(ctx, next){
      document.body.dispatchEvent(new CustomEvent("page-navigation", {
        detail: {
        }
      }));
      next();
    });

    page('/', function () {
      app.loadDependency('dashboard/page-welcome').then(function(){
        app.route = 'home';
      });
    });

    page('/login', function (data) {
      app.loadDependency('auth/page-login').then(function(){
        app.route = 'login';
      });
    });

    page('/user/:id/:title?', function (data) {
      app.loadDependency('auth/page-user').then(function(){
        app.route = 'user';
        app.set('params.userId', data.params.id);
      });
    });

    page('/forgot-my-password/:token?', function (data) {
      app.loadDependency('auth/page-forgotten-password').then(function(){
        if(data.params.token){
          app.set('params.passwordResetToken', data.params.token);
        }
        app.route = 'forgotten-password';
      });
    });

    page('/register', function (data) {
      app.loadDependency('auth/page-register').then(function() {
        app.route = 'register';
      });
    });

    page('/settings', function (data) {
      app.loadDependency('settings/page-settings').then(function(){
        app.route = 'settings';
      });
    });

    page('/logout', function (data) {
      delete localStorage.token;
      location.href = '/';
    });

    page('/books', function (data) {
      app.loadDependency('books/page-books').then(function() {
        app.route = 'books';
      });
    });

    page('/recent/questions', function (data) {
      app.loadDependency('qa/page-recent-qa').then(function() {
        app.route = 'recent-qa';
      });
    });

    page('/book/:ref', function (data) {
      app.loadDependency('text/page-book').then(function(){
        app.route = 'book';
        app.set('params.bookRef', data.params.ref);
      });
    });

    page('/questions/ask/:verses', function (data) {
      app.loadDependency('qa/page-new-question').then(function(){
        app.route = 'new-question';
        app.set('params.newQuestionVerses', data.params.verses);
      });
    });

    page('/:questionOrAnswer/:id/history', function(data) {
      app.loadDependency('qa/page-post-history').then(function() {
        app.route = 'post-history';
        app.set('params.postId', data.params.id);
        app.set('params.postType', data.params.questionOrAnswer);
      });
    });

    page('/question/:id/edit', function(data) {
      app.loadDependency('qa/page-edit-question').then(function() {
        app.route = 'edit-question';
        app.set('params.questionId', data.params.id);
      });
    });

    page('/answer/:id/edit', function(data) {
      app.loadDependency('qa/page-edit-answer').then(function() {
        app.route = 'edit-answer';
        app.set('params.answerId', data.params.id);
      });
    });

    page('/question/:id/:title?', function(data) {
      app.loadDependency('qa/page-question').then(function(){
        app.route = 'question';
        app.set('params.questionId', data.params.id);
      });
    });

    page('/search', function() {
      app.loadDependency('search/page-search').then(function(){
        app.route = 'search';
        app.set('params.searchQuery', '');
      });
    });

    page('/search/:query', function (data) {
      app.loadDependency('search/page-search').then(function(){
        app.route = 'search';
        app.set('params.searchQuery', data.params.query);
      });
    });

    page('/help/how-to-ask', function (data) {
      app.loadDependency('documentation/page-rules-questions').then(function(){
        app.route = 'rules-questions';
      });
    });

    page('/help/how-to-answer', function (data) {
      app.loadDependency('documentation/page-rules-answers').then(function(){
        app.route = 'rules-answers';
      });
    });

    page('/help/search', function (data) {
      app.loadDependency('documentation/page-search-docs').then(function(){
        app.route = 'search-docs';
      });
    });

    page('/help/faq', function (data) {
      app.loadDependency('documentation/page-faq').then(function(){
        app.route = 'faq';
      });
    });


    page('/philosophy', function (data) {
      app.loadDependency('documentation/page-philosophy').then(function(){
        app.route = 'philosophy';
      });
    });

    page('/topic/:name', function (data) {
      app.loadDependency('topics/page-topic').then(function(){
        app.route = 'topic';
        app.set('params.topicName', data.params.name);
      });
    });

    page('/legal', function (data) {
      app.loadDependency('documentation/page-legal').then(function(){
        app.route = 'legal';
      });
    });

    page('*', function(){
      app.loadDependency('documentation/page-not-found').then(function(){
        app.route = 'not-found';
      });
    });

    // add #! before urls
    page({
      hashbang: false
    });

  });
</script>
