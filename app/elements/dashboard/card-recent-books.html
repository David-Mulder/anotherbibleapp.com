<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../utils/relative-time.html">

<link id="bible-reference-parser" rel="import" href="../utils/bible-reference-parser.html">

<dom-module id="card-recent-books">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host{
        display: block;
      }
      #card{
        display: block;
      }
      #card .card-content{
        padding-top: 0px;
      }
      relative-time{
        color: var(--secondary-text-on-card-dialog-color);
        font-size: smaller;
      }
      .book:hover{
        background: rgba(0,0,0,.05);
        cursor: pointer;
      }
    </style>
    <synced-settings id="settings"></synced-settings>
    <paper-card id="card" heading="Recent Books" hidden$="{{noResults}}">
      <template is="dom-repeat" items="{{books}}" as="book">
        <div class="card-actions book" on-tap="goToBook">
          {{book.title}}

          <relative-time time="{{book.date}}"></relative-time>
        </div>
      </template>
    </paper-card>

  </template>

  <script>
    (function() {
      'use strict';

      var BibleReference = require('bible-reference-parser');

      Polymer({
        properties: {
          books: Array
        },

        reload: function(){
          this.$.settings.getAllSettings().then(function(settings){

            console.info('settings', JSON.parse(JSON.stringify(settings)));

            var settingNames = Object.keys(settings);

            var settingNameStart = 'book-reading-position-';

            settingNames = settingNames.filter(function(name){
              return name.substring(0, settingNameStart.length) === settingNameStart;
            });

            settings = settingNames.map(function(setting){
              settings[setting].value.date = new Date(settings[setting].value.date);
              return settings[setting];
            });

            settings.sort(function(a, b){
              return b.value.date - a.value.date;
            });

            settings.splice(3);

            this.books = [];

            settings.forEach(function(setting){
              var reference = new BibleReference(setting.value.position);
              this.push('books', {
                title: reference.book.title,
                reference: reference.toString(),
                date: setting.value.date
              });
            }.bind(this));
            this.noResults = this.books.length == 0;

          }.bind(this)).catch(function(err){
            alert(err);
          });
        },

        goToBook: function(ev){
          //piercing the router consciously
          window.doSavePosition = true;

          page('/book/'+ev.model.book.reference);
        }

      });
    })();
  </script>

</dom-module>
