<script>
  var xml = `
    <dom><p>
      <verse-number id="1"></verse-number>
      Lorem ipsum dolar <idiom>also known as dollar</idiom> sit <verse-number id="2"></verse-number>amet.
      <ul>
        <li>
          consectetur <note>in</note> adipiscing <verse-number id="3"></verse-number>elit.
        </li>
        <li>
          Nunc finibus, neque aliquam <verse-number id="4"></verse-number>ultrices ornare,
        </li>
      </ul>
    </p>
    <p>
      orci quam elementum.
    </p>
    Antro periscope.
    <verse-number id="5"></verse-number>
    <p>
      Tontro derilium.
    </p>
  </dom>
  `;

  xml = `<p><verse-number id="Dt 7:7">7</verse-number>“Yahweh loved you and chose you not <idiom-start />because of your great number<idiom-end /><note>Literally “from your multitude/abundance”</note> exceeding all <supplied>other</supplied> peoples, for you <supplied>are</supplied> fewer than all of the peoples, <verse-number id="Dt 7:8">8</verse-number>but<note>Or “for”</note> <idiom-start />because of<idiom-end /><note>Literally “from”</note> the love of Yahweh <supplied>for</supplied> you and because of his keeping <supplied>of</supplied> the sworn oath that he swore to your ancestors,<note>Or “fathers”</note> Yahweh brought you <supplied>out</supplied> with a strong hand and redeemed you from the house of slavery, from the hand of Pharaoh, the king of Egypt. <verse-number id="Dt 7:9">9</verse-number><supplied>So</supplied> know that Yahweh your God, he <supplied>is</supplied> God, the trustworthy God, maintaining his<note>Hebrew “the”</note> covenant and his<note>Hebrew “the”</note> loyal love with those who love him and with those who keep his commandments to a thousand generations,<note>Hebrew “generation”</note> <verse-number id="Dt 7:10">10</verse-number>but repaying those<note>Hebrew “the one”</note> who hate him <idiom-start />in their own person<idiom-end /><note>Literally “to their faces”</note> to destroy them;<note>Hebrew “him”; “them” in sense</note> he is not slow with those who hate him <idiom-start />in their own person<idiom-end />;<note>Literally “to their faces”</note> he repays them.<note>Hebrew “him”</note> <verse-number id="Dt 7:11">11</verse-number>And <supplied>so</supplied> you shall keep the commandment and the rules and the regulations that I <supplied>am</supplied> commanding you <idiom-start />today<idiom-end /><note>Literally “the day”</note> to observe them. </p>`;

  xml = `<chapter id="Ac 1"> <pericope>The Ascension</pericope> <p><verse-number id="Ac 1:6">6</verse-number>So <supplied>when</supplied><note tag="NOT_FOR_PRINT"><info> *Here “<supplied>when</supplied>” is supplied as a component of the participle (“had come together”) which is understood as temporal</info></note> they had come together, they began asking<note tag="NOT_FOR_PRINT"><info> *The imperfect tense has been translated as ingressive here (“began asking”)</info></note> him, saying, “Lord, <supplied>is it</supplied> at this time you are restoring the kingdom to Israel?” <verse-number id="Ac 1:7">7</verse-number>But he said to them, “It is not for you to know <supplied>the</supplied> times or seasons that the Father has set by his own authority. <verse-number id="Ac 1:8">8</verse-number>But you will receive power <supplied>when</supplied><note tag="NOT_FOR_PRINT"><info> *Here “<supplied>when</supplied>” is supplied as a component of the temporal genitive absolute participle (“has come”)</info></note> the Holy Spirit has come upon you, and you will be my witnesses in Jerusalem, and in all Judea and Samaria, and to the farthest part of the earth.” <verse-number id="Ac 1:9">9</verse-number>And <supplied>after he</supplied><note tag="NOT_FOR_PRINT"><info> *Here “<supplied>after</supplied>” is supplied as a component of the participle (“had said”) which is understood as temporal</info></note> had said these <supplied>things</supplied>, <supplied>while</supplied><note tag="NOT_FOR_PRINT"><info> *Here “<supplied>while</supplied>” is supplied as a component of the temporal genitive absolute participle (“were watching”)</info></note> they were watching, he was taken up, and a cloud received him from their sight. <verse-number id="Ac 1:10">10</verse-number>And as they were staring into the sky <supplied>while</supplied><note tag="NOT_FOR_PRINT"><info> *Here “<supplied>while</supplied>” is supplied as a component of the temporal genitive absolute participle (“was departing”)</info></note> he was departing, behold, two men in white clothing stood by them <verse-number id="Ac 1:11">11</verse-number>who also said, “Men <idiom>of Galilee</idiom>,<note><info>Literally “Galileans”</info></note> why do you stand there looking<note><info>Some manuscripts have “gazing”</info></note> into the sky? This Jesus who was taken up from you into heaven like this will come back in the same way you saw him departing into heaven!” </p>  <pericope>Matthias Chosen to Replace Judas</pericope> <p><verse-number id="Ac 1:12">12</verse-number>Then they returned to Jerusalem from the mountain that is called Olive Grove<note><info>This is a variation of the name “Mount of Olives”</info></note> which is near Jerusalem, a Sabbath day’s journey away.<note><info>Literally “having a journey of a Sabbath”</info></note> <verse-number id="Ac 1:13">13</verse-number>And when they had entered, they went up to the upstairs room where they were staying—Peter and John and James and Andrew, Philip and Thomas, Bartholomew and Matthew, James <supplied>son</supplied> of Alphaeus and Simon the Zealot and Judas <supplied>son</supplied> of James. <verse-number id="Ac 1:14">14</verse-number>All these were busily engaged with one mind in prayer, together with the women and Mary the mother of Jesus and with<note><info>Some manuscripts omit “with”</info></note> his brothers. </p> <p><verse-number id="Ac 1:15">15</verse-number>And in those days Peter stood up in the midst of the brothers (and it was a crowd of persons of about one hundred twenty at the same <supplied>place</supplied>) <supplied>and</supplied><note tag="NOT_FOR_PRINT"><info> *Here “<supplied>and</supplied>” is supplied because the previous participle (“stood up”) has been translated as a finite verb</info></note> said, <verse-number id="Ac 1:16">16</verse-number>“Men <supplied>and</supplied> brothers, it was necessary <supplied>that</supplied> the scripture be fulfilled, which the Holy Spirit proclaimed beforehand through the mouth of David concerning Judas, who became a guide to those who arrested Jesus, <verse-number id="Ac 1:17">17</verse-number>because he was counted among us and received a share in this ministry.” <verse-number id="Ac 1:18">18</verse-number>(Now this man acquired a field for the wages of <supplied>his</supplied> wickedness, and falling headlong, he burst open in the middle and all his intestines spilled out. <verse-number id="Ac 1:19">19</verse-number>And it became known to all who live in Jerusalem, so that that field was called in their own language<note><info>That is, Aramaic</info></note> “Akeldama,” that is, “Field of Blood.”) <verse-number id="Ac 1:20">20</verse-number>“For it is written in the book of Psalms, <ul> <li class="level-1">‘Let his residence become deserted, </li> <li class="level-2">and let there be no one to live in it,’<note><info>A quotation from <cite title="BibleLEB2: Ps 69:25">Ps 69:25</cite></info></note> </li> </ul></p>    <p><verse-number id="Ac 1:20" tag="PARAGRAPH_ONLY">20</verse-number>and, <ul> <li class="level-1">‘Let another person take his position.’<note><info>A quotation from <cite title="BibleLEB2: Ps 109:8">Ps 109:8</cite></info></note> </li> </ul></p>    <p><verse-number id="Ac 1:21">21</verse-number>Therefore it is necessary for <supplied>one</supplied> of the men who have accompanied us during all the time <supplied>in</supplied> which the Lord Jesus went in and went out among us, <verse-number id="Ac 1:22">22</verse-number>beginning from the baptism of John until the day <supplied>on</supplied> which he was taken up from us—one of these <supplied>men</supplied> must become a witness of his resurrection together with us.” <verse-number id="Ac 1:23">23</verse-number>And they proposed two <supplied>men</supplied>, Joseph called Barsabbas (who was called Justus) and Matthias. <verse-number id="Ac 1:24">24</verse-number>And they prayed <supplied>and</supplied><note tag="NOT_FOR_PRINT"><info> *Here “<supplied>and</supplied>” is supplied because the previous participle (“prayed”) has been translated as a finite verb</info></note> said, “You, Lord, who know the hearts of all, show clearly which one of these two you have chosen <verse-number id="Ac 1:25">25</verse-number>to take the place in this ministry and apostleship from which Judas turned aside to depart to his own place.” <verse-number id="Ac 1:26">26</verse-number>And they cast lots for them, and the lot fell on Matthias, and he was added <supplied>to serve</supplied><note tag="NOT_FOR_PRINT"><info> *The words “<supplied>to serve</supplied>” are not in the Greek text, but are implied</info></note> with the eleven apostles. </p> </chapter>`;

  var domParser = new DOMParser();
  var dom = domParser.parseFromString(xml, 'text/xml');

  var prevId;

  var versify = function(dom) {
    var treeWalker = document.createTreeWalker(dom);
    while (treeWalker.nextNode()) {
      var cn = treeWalker.currentNode;
      if (cn.nodeName === 'verse-number') {
        prevId = cn.id;
        //console.log(cn);
        //cn.parentNode.removeChild(cn);
        //console.log(prevId);
        cn.classList.add('remove');
      }

      var prevSiblingVerseNumber = false;
      var containsVerseNumber = false;
      if (cn.previousSibling) {
        //console.log('nodename', cn.previousSibling.nodeName);
        if (cn.previousSibling.nodeName == 'verse-number' && !cn.previousSibling.classList.contains('remove')) {
          if(cn.previousSibling.id == prevId){
            prevSiblingVerseNumber = true;
          }
        }
      }
      if (cn.nodeType === 1 && cn.querySelector('verse-number')) {
        containsVerseNumber = true;
      }
      //console.log(cn.nodeName, prevSiblingVerseNumber, containsVerseNumber);
      if (prevSiblingVerseNumber && !containsVerseNumber) {
        //console.log('append', cn, 'into', cn.previousSibling);
        cn.previousSibling.appendChild(cn);
      }

      if (cn.nodeType === 3) {
        if (cn.textContent.trim().length > 0) {
          //console.group(cn);
          var inMarker = false;
          var inPericope = false;
          var inNote = false;

          var current = cn.parentElement;
          while (current) {
            if (current.nodeName == 'verse-number') {
              inMarker = true;
            }
            if(current.nodeName == 'pericope'){
              inPericope = true;
            }
            if(current.nodeName == 'note'){
              inNote = true;
            }
            //console.log(current.nodeName);
            current = current.parentElement;
          }

          //console.log(cn.textContent, inMarker, inPericope, inNote);
          if (!inMarker && !inPericope && !inNote ) {
            var marker = document.createElement('verse-number');
            marker.setAttribute('id', prevId);
            if (cn.nextSibling) {
              cn.parentNode.insertBefore(marker, cn.nextSibling);
            } else {
              cn.parentNode.appendChild(marker);
            }
            marker.appendChild(cn);
          }
          //console.dir(cn);
          //console.groupEnd();
        }
      }
    }
    var remove = dom.querySelectorAll('.remove');
    for (var i = 0; i < remove.length; i++) {
      remove[i].parentNode.removeChild(remove[i]);
    }
  };
  versify(dom);
  console.log(dom.children[0]);
</script>
