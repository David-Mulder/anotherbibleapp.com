<script>
  var xml = `
    <dom><p>
      <verse-number id="1"></verse-number>
      Lorem ipsum dolar <idiom>also known as dollar</idiom> sit <verse-number id="2"></verse-number>amet.
      <ul>
        <li>
          consectetur <note>in</note> adipiscing <verse-number id="3"></verse-number>elit.
        </li>
        <li>
          Nunc finibus, neque aliquam <verse-number id="4"></verse-number>ultrices ornare,
        </li>
      </ul>
    </p>
    <p>
      orci quam elementum.
    </p>
    Antro periscope.
    <verse-number id="5"></verse-number>
    <p>
      Tontro derilium.
    </p>
  </dom>
  `;

  xml = `<p><verse-number id="Dt 7:7">7</verse-number>“Yahweh loved you and chose you not <idiom-start />because of your great number<idiom-end /><note>Literally “from your multitude/abundance”</note> exceeding all <supplied>other</supplied> peoples, for you <supplied>are</supplied> fewer than all of the peoples, <verse-number id="Dt 7:8">8</verse-number>but<note>Or “for”</note> <idiom-start />because of<idiom-end /><note>Literally “from”</note> the love of Yahweh <supplied>for</supplied> you and because of his keeping <supplied>of</supplied> the sworn oath that he swore to your ancestors,<note>Or “fathers”</note> Yahweh brought you <supplied>out</supplied> with a strong hand and redeemed you from the house of slavery, from the hand of Pharaoh, the king of Egypt. <verse-number id="Dt 7:9">9</verse-number><supplied>So</supplied> know that Yahweh your God, he <supplied>is</supplied> God, the trustworthy God, maintaining his<note>Hebrew “the”</note> covenant and his<note>Hebrew “the”</note> loyal love with those who love him and with those who keep his commandments to a thousand generations,<note>Hebrew “generation”</note> <verse-number id="Dt 7:10">10</verse-number>but repaying those<note>Hebrew “the one”</note> who hate him <idiom-start />in their own person<idiom-end /><note>Literally “to their faces”</note> to destroy them;<note>Hebrew “him”; “them” in sense</note> he is not slow with those who hate him <idiom-start />in their own person<idiom-end />;<note>Literally “to their faces”</note> he repays them.<note>Hebrew “him”</note> <verse-number id="Dt 7:11">11</verse-number>And <supplied>so</supplied> you shall keep the commandment and the rules and the regulations that I <supplied>am</supplied> commanding you <idiom-start />today<idiom-end /><note>Literally “the day”</note> to observe them. </p>`;

  var domParser = new DOMParser();
  var dom = domParser.parseFromString(xml, 'text/xml');

  var prevId;

  var versify = function(dom) {
    var treeWalker = document.createTreeWalker(dom);
    while (treeWalker.nextNode()) {
      var cn = treeWalker.currentNode;
      if (cn.nodeName === 'verse-number') {
        prevId = cn.id;
        //console.log(cn);
        //cn.parentNode.removeChild(cn);
        //console.log(prevId);
        cn.classList.add('remove');
      }

      var prevSiblingVerseNumber = false;
      var containsVerseNumber = false;
      if (cn.previousSibling) {
        //console.log('nodename', cn.previousSibling.nodeName);
        if (cn.previousSibling.nodeName == 'verse-number' && !cn.previousSibling.classList.contains('remove')) {
          if(cn.previousSibling.id == prevId){
            prevSiblingVerseNumber = true;
          }
        }
      }
      if (cn.nodeType === 1 && cn.querySelector('verse-number')) {
        containsVerseNumber = true;
      }
      //console.log(cn.nodeName, prevSiblingVerseNumber, containsVerseNumber);
      if (prevSiblingVerseNumber && !containsVerseNumber) {
        //console.log('append', cn, 'into', cn.previousSibling);
        cn.previousSibling.appendChild(cn);
      }

      if (cn.nodeType === 3) {
        if (cn.textContent.trim().length > 0) {
          //console.group(cn);
          var inMarker = false;
          var inPericope = false;
          var inNote = false;

          var current = cn.parentElement;
          while (current) {
            if (current.nodeName == 'verse-number') {
              inMarker = true;
            }
            if(current.nodeName == 'pericope'){
              inPericope = true;
            }
            if(current.nodeName == 'note'){
              inNote = true;
            }
            //console.log(current.nodeName);
            current = current.parentElement;
          }

          //console.log(cn.textContent, inMarker, inPericope, inNote);
          if (!inMarker && !inPericope && !inNote ) {
            var marker = document.createElement('verse-number');
            marker.setAttribute('id', prevId);
            if (cn.nextSibling) {
              cn.parentNode.insertBefore(marker, cn.nextSibling);
            } else {
              cn.parentNode.appendChild(marker);
            }
            marker.appendChild(cn);
          }
          //console.dir(cn);
          //console.groupEnd();
        }
      }
    }
    var remove = dom.querySelectorAll('.remove');
    for (var i = 0; i < remove.length; i++) {
      remove[i].parentNode.removeChild(remove[i]);
    }
  };
  versify(dom);
  console.log(dom);
</script>
